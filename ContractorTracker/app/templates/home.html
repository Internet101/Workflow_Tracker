{% extends "base.html" %}

{% block content %}
<h1>Job Library</h1>

<!-- Add Job Form -->
<div class="mb-4">
    <h3>Add Job</h3>
    <form id="add-contract-form" class="row g-3" enctype="multipart/form-data">
        <div class="col-md-3">
            <label for="job_id" class="form-label">Job ID</label>
            <input type="text" id="job_id" class="form-control" required>
        </div>
        <div class="col-md-6">
            <label for="description" class="form-label">Description</label>
            <input type="text" id="description" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label for="start_date" class="form-label">Start Date</label>
            <input type="date" id="start_date" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label for="end_date" class="form-label">End Date</label>
            <input type="date" id="end_date" class="form-control">
        </div>
        <div class="col-md-3">
            <label for="job_pack" class="form-label">Job Pack (PDF)</label>
            <input type="file" id="job_pack" class="form-control" accept=".pdf">
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-success">Add Job</button>
        </div>
    </form>
    <p id="add-contract-message" class="mt-3 text-success" style="display: none;">Job added successfully!</p>
</div>

<!-- Job Library Table -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Job ID</th>
            <th>Description</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Job Pack</th>
        </tr>
    </thead>
    <tbody id="contracts-table">
        <!-- Populated dynamically -->
    </tbody>
</table>

<script>
    // Fetch all contracts
    function fetchContracts() {
        fetch('/contracts-data')
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('contracts-table');
                table.innerHTML = ''; // Clear existing rows
                data.contracts.forEach(contract => {
                    const row = `
                        <tr>
                            <td>${contract.id}</td>
                            <td>${contract.job_id}</td>
                            <td>${contract.description}</td>
                            <td>${contract.start_date}</td>
                            <td>${contract.end_date || 'N/A'}</td>
                            <td>
                                ${contract.job_pack_path
                                    ? `<a href="/job-packs/${contract.job_pack_path}" target="_blank">View</a>`
                                    : 'N/A'}
                            </td>
                        </tr>`;
                    table.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error fetching contracts:', error);
            });
    }
    fetchContracts(); // Initial fetch

    // Add contract
    document.getElementById('add-contract-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('job_id', document.getElementById('job_id').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('start_date', document.getElementById('start_date').value);
        formData.append('end_date', document.getElementById('end_date').value || '');
        formData.append('job_pack', document.getElementById('job_pack').files[0]);

        fetch('/contracts', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                document.getElementById('add-contract-message').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('add-contract-message').style.display = 'none';
                }, 3000);
                fetchContracts(); // Refresh the table
            } else {
                alert('Failed to add job.');
            }
        })
        .catch(error => {
            console.error('Error adding job:', error);
        });
    });
</script>
{% endblock %}
