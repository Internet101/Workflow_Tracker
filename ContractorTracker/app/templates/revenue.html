{% extends "base.html" %}

{% block content %}
<h1>Contracts and Revenue</h1>

<!-- Add Revenue Form -->
<div class="mb-4">
    <h3>Add Revenue</h3>
    <form id="add-revenue-form" class="row g-3" enctype="multipart/form-data">
        <div class="col-md-3">
            <label for="user_id" class="form-label">User ID</label>
            <input type="text" id="user_id" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label for="contract_id" class="form-label">Contract ID</label>
            <input type="text" id="contract_id" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label for="dwellings" class="form-label">Number of Dwellings</label>
            <input type="number" id="dwellings" class="form-control" step="1" min="1" required>
        </div>
        <div class="col-md-3">
            <label for="is_blown" class="form-label">Is Blown?</label>
            <select id="is_blown" class="form-control" required>
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="amount" class="form-label">Total Amount</label>
            <input type="text" id="amount" class="form-control" readonly>
        </div>
        <div class="col-md-3">
            <label for="date" class="form-label">Date</label>
            <input type="date" id="date" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label for="job_pack" class="form-label">Job Pack (PDF)</label>
            <input type="file" id="job_pack" class="form-control" accept=".pdf">
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-success">Add Revenue</button>
        </div>
    </form>
    <p id="add-revenue-message" class="mt-3 text-success" style="display: none;">Revenue added successfully!</p>
</div>

<!-- Revenue Records Table -->
<h3>Existing Contracts and Revenue</h3>
<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>User ID</th>
            <th>Contract ID</th>
            <th>Number of Dwellings</th>
            <th>Is Blown</th>
            <th>Total Amount</th>
            <th>Date</th>
            <th>Job Pack</th>
        </tr>
    </thead>
    <tbody id="revenue-table">
        {% for record in revenue_data %}
        <tr>
            <td>{{ record.id }}</td>
            <td>{{ record.user_id }}</td>
            <td>{{ record.contract_id }}</td>
            <td>{{ record.dwellings }}</td>
            <td>{{ "Yes" if record.is_blown else "No" }}</td>
            <td>£{{ record.amount }}</td>
            <td>{{ record.date }}</td>
            <td>
                {% if record.job_pack_path %}
                <a href="{{ url_for('main.serve_job_pack', filename=record.job_pack_path) }}" target="_blank">View</a>
                {% else %}
                N/A
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    const ratePerDwelling = 35; // Rate per dwelling
    const blownFee = 40; // Fixed fee for blown jobs

    // Calculate the total amount based on dwellings and "Is Blown?" status
    function calculateTotalAmount() {
        const dwellings = parseInt(document.getElementById('dwellings').value) || 0;
        const isBlown = document.getElementById('is_blown').value === "yes";
        const totalAmount = (isBlown ? blownFee : 0) + (dwellings * ratePerDwelling);
        document.getElementById('amount').value = `£${totalAmount.toFixed(2)}`; // Update the calculated amount
    }

    document.getElementById('dwellings').addEventListener('input', calculateTotalAmount);
    document.getElementById('is_blown').addEventListener('change', calculateTotalAmount);

    // Fetch all revenue data
    function fetchRevenueData() {
        fetch('/revenue-data')
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('revenue-table');
                table.innerHTML = ''; // Clear existing rows
                data.revenue.forEach(record => {
                    const row = `
                        <tr>
                            <td>${record.id}</td>
                            <td>${record.user_id}</td>
                            <td>${record.contract_id}</td>
                            <td>${record.dwellings}</td>
                            <td>${record.is_blown ? "Yes" : "No"}</td>
                            <td>£${record.amount.toFixed(2)}</td>
                            <td>${record.date}</td>
                            <td>
                                ${record.job_pack_path ? `<a href="/job-packs/${record.job_pack_path}" target="_blank">View</a>` : 'N/A'}
                            </td>
                        </tr>`;
                    table.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error fetching revenue data:', error);
            });
    }
    fetchRevenueData(); // Initial fetch

    // Add Revenue
    document.getElementById('add-revenue-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('user_id', document.getElementById('user_id').value);
        formData.append('contract_id', document.getElementById('contract_id').value);
        formData.append('dwellings', parseInt(document.getElementById('dwellings').value));
        formData.append('is_blown', document.getElementById('is_blown').value === "yes");
        formData.append('date', document.getElementById('date').value);
        formData.append('job_pack', document.getElementById('job_pack').files[0]);

        fetch('/revenue', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                document.getElementById('add-revenue-message').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('add-revenue-message').style.display = 'none';
                }, 3000);
                fetchRevenueData(); // Refresh the table
            } else {
                alert('Failed to add revenue.');
            }
        })
        .catch(error => {
            console.error('Error adding revenue:', error);
        });
    });
</script>
{% endblock %}
